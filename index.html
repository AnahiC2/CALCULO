<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Derivadas</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1, h2 {
            color: #2c3e50;
        }
        .container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input, button {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        input {
            width: 300px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        #result, #steps {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .step {
            margin-bottom: 10px;
        }
        .graph-container {
            margin-top: 30px;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .info {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>Calculadora de Derivadas Paso a Paso</h1>
    
    <div class="container">
        <h2>Ingresa tu función</h2>
        <p>Ejemplos: x^2, sin(x), 3x^3 + 2x - 5, e^x, ln(x), sqrt(x)</p>
        <input type="text" id="functionInput" placeholder="Ejemplo: x^2 + 3x - 5">
        <button onclick="calculateDerivative()">Calcular Derivada</button>
        <p class="info">Usa ^ para exponentes (x^2), * para multiplicación (3*x), y paréntesis para agrupación.</p>
    </div>
    
    <div class="container">
        <h2>Resultado</h2>
        <div id="result">La derivada aparecerá aquí...</div>
        
        <h3>Pasos de la solución</h3>
        <div id="steps">Los pasos detallados aparecerán aquí...</div>
    </div>
    
    <div class="container graph-container">
        <h2>Gráfica de la función y su derivada</h2>
        <canvas id="functionChart" width="400" height="200"></canvas>
    </div>

    <script>
        let functionChart = null;
        
        function calculateDerivative() {
            const input = document.getElementById('functionInput').value.trim();
            if (!input) {
                showError("Por favor ingresa una función.");
                return;
            }
            
            try {
                // Limpiar resultados anteriores
                document.getElementById('result').innerHTML = "Calculando...";
                document.getElementById('steps').innerHTML = "";
                
                // Parsear la función y calcular la derivada
                const parsedFunc = parseFunction(input);
                const derivative = computeDerivative(parsedFunc);
                
                // Mostrar resultados
                displayResult(input, derivative);
                displaySteps(parsedFunc, derivative);
                plotFunctionAndDerivative(input, derivative.expression);
                
            } catch (error) {
                showError("Error al calcular la derivada: " + error.message);
                console.error(error);
            }
        }
        
        function parseFunction(input) {
            // Simplificación: este es un parser muy básico
            // En una aplicación real, usarías una librería como math.js o expr-eval
            
            // Reemplazar notaciones alternativas
            let expr = input.toLowerCase()
                .replace(/sqrt\(([^)]+)\)/g, '($1)^(1/2)')
                .replace(/\s+/g, '') // Eliminar espacios
                .replace(/([0-9])([a-z])/g, '$1*$2') // 3x -> 3*x
                .replace(/([a-z])([0-9])/g, '$1*$2') // x3 -> x*3
                .replace(/([)])([a-z0-9(])/g, '$1*$2') // )( -> )*(
                .replace(/([0-9)])([(])/g, '$1*$2'); // 3( -> 3*(
            
            // Validar caracteres permitidos
            if (!/^[0-9x+\-*/^().sincotaelg]+$/.test(expr)) {
                throw new Error("La función contiene caracteres no permitidos.");
            }
            
            return {
                raw: input,
                expression: expr
            };
        }
        
        function computeDerivative(func) {
            // Simplificación: este es un derivador simbólico muy básico
            // En una aplicación real, usarías una librería como math.js o symbolic.js
            
            let expr = func.expression;
            let steps = [];
            let derivative = "";
            
            // Reglas básicas de derivación
            if (expr === "x") {
                derivative = "1";
                steps.push("La derivada de x es 1.");
            } 
            else if (/^[0-9]+$/.test(expr)) {
                derivative = "0";
                steps.push("La derivada de una constante es 0.");
            }
            else if (expr.includes("^")) {
                const parts = expr.split("^");
                if (parts[0] === "x" || parts[0] === "(x)") {
                    const exponent = parts[1].replace(/[()]/g, '');
                    derivative = exponent + "*x^(" + exponent + "-1)";
                    steps.push(`Aplicando la regla de la potencia: d/dx[x^${exponent}] = ${exponent}*x^(${exponent}-1)`);
                } else {
                    throw new Error("Solo se soportan potencias de x como x^n.");
                }
            }
            else if (expr.includes("sin(x)")) {
                derivative = "cos(x)";
                steps.push("La derivada de sin(x) es cos(x).");
            }
            else if (expr.includes("cos(x)")) {
                derivative = "-sin(x)";
                steps.push("La derivada de cos(x) es -sin(x).");
            }
            else if (expr.includes("e^x")) {
                derivative = "e^x";
                steps.push("La derivada de e^x es e^x.");
            }
            else if (expr.includes("ln(x)")) {
                derivative = "1/x";
                steps.push("La derivada de ln(x) es 1/x.");
            }
            else if (expr.includes("+")) {
                const terms = expr.split("+");
                const derivatives = terms.map(term => computeDerivative({expression: term}));
                derivative = derivatives.map(d => d.expression).join("+");
                steps.push("Aplicando la regla de la suma: la derivada de una suma es la suma de las derivadas.");
                derivatives.forEach((d, i) => {
                    steps.push(`Derivada del término ${terms[i]}: ${d.expression}`);
                });
            }
            else if (expr.includes("-")) {
                const terms = expr.split("-");
                const derivatives = terms.map(term => computeDerivative({expression: term}));
                derivative = derivatives.map(d => d.expression).join("-");
                steps.push("Aplicando la regla de la resta: la derivada de una resta es la resta de las derivadas.");
                derivatives.forEach((d, i) => {
                    steps.push(`Derivada del término ${terms[i]}: ${d.expression}`);
                });
            }
            else if (expr.includes("*")) {
                // Implementación básica de la regla del producto
                const terms = expr.split("*");
                if (terms.length !== 2) throw new Error("Solo se soportan productos de dos términos.");
                
                const f = terms[0], g = terms[1];
                const df = computeDerivative({expression: f}).expression;
                const dg = computeDerivative({expression: g}).expression;
                
                derivative = `(${df})*${g} + ${f}*(${dg})`;
                steps.push(`Aplicando la regla del producto: d/dx[${f}*${g}] = (d/dx[${f}])*${g} + ${f}*(d/dx[${g}])`);
                steps.push(`Derivada de ${f}: ${df}`);
                steps.push(`Derivada de ${g}: ${dg}`);
            }
            else {
                throw new Error("Formato de función no soportado. Intenta con algo como x^2, sin(x), etc.");
            }
            
            return {
                expression: derivative,
                steps: steps
            };
        }
        
        function displayResult(originalFunc, derivative) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <p>Función original: \\( f(x) = ${originalFunc} \\)</p>
                <p>Derivada: \\( f'(x) = ${derivative.expression} \\)</p>
            `;
            MathJax.typeset();
        }
        
        function displaySteps(parsedFunc, derivative) {
            const stepsDiv = document.getElementById('steps');
            let stepsHTML = "";
            
            stepsHTML += `<div class="step"><strong>Función original:</strong> \\( f(x) = ${parsedFunc.raw} \\)</div>`;
            
            derivative.steps.forEach(step => {
                stepsHTML += `<div class="step">${step}</div>`;
            });
            
            stepsHTML += `<div class="step"><strong>Resultado final:</strong> \\( f'(x) = ${derivative.expression} \\)</div>`;
            
            stepsDiv.innerHTML = stepsHTML;
            MathJax.typeset();
        }
        
        function plotFunctionAndDerivative(originalFunc, derivativeExpr) {
            // Limpiar gráfica anterior si existe
            if (functionChart) {
                functionChart.destroy();
            }
            
            const ctx = document.getElementById('functionChart').getContext('2d');
            
            // Generar datos para la gráfica
            const labels = [];
            const originalData = [];
            const derivativeData = [];
            
            const start = -5;
            const end = 5;
            const step = 0.1;
            
            for (let x = start; x <= end; x += step) {
                try {
                    labels.push(x.toFixed(1));
                    originalData.push(evaluateFunction(originalFunc, x));
                    derivativeData.push(evaluateFunction(derivativeExpr, x));
                } catch (e) {
                    // Ignorar puntos donde la función no está definida
                }
            }
            
            functionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `f(x) = ${originalFunc}`,
                            data: originalData,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            borderWidth: 2
                        },
                        {
                            label: `f'(x) = ${derivativeExpr}`,
                            data: derivativeData,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Función y su derivada'
                        }
                    }
                }
            });
        }
        
        function evaluateFunction(funcStr, x) {
            // Evaluar la función en un punto x (muy básico, sin seguridad)
            // En una aplicación real usarías math.js o expr-eval
            
            // Reemplazar x con el valor numérico
            let expr = funcStr.replace(/x/g, `(${x})`);
            
            // Reemplazar funciones matemáticas
            expr = expr.replace(/sin/g, 'Math.sin')
                      .replace(/cos/g, 'Math.cos')
                      .replace(/e\^/g, 'Math.exp')
                      .replace(/ln/g, 'Math.log')
                      .replace(/\^/g, '**');
            
            // Evaluar la expresión (CUIDADO: esto puede ser peligroso sin sanitización adecuada)
            return eval(expr);
        }
        
        function showError(message) {
            document.getElementById('result').innerHTML = `<span class="error">${message}</span>`;
            document.getElementById('steps').innerHTML = "";
            
            if (functionChart) {
                functionChart.destroy();
                functionChart = null;
            }
        }
    </script>
</body>
</html>
